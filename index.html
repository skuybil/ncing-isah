<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Data Alat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow flex flex-col md:flex-row gap-6">

        <div class="md:w-1/3 bg-gray-50 p-4 rounded-lg shadow">
            <h1 class="text-xl font-bold mb-4">Manajemen Data Alat</h1>
            <input type="hidden" id="editIndex">
            
            <div class="mb-4 p-2 bg-blue-50 rounded">
                <label class="block text-sm font-medium text-gray-700">Kode Barang</label>
                <div id="kodeBarangDisplay" class="font-mono text-blue-600">Isi semua field untuk generate kode</div>
            </div>
            
            <input type="text" id="namaBarang" placeholder="Nama Barang" class="border p-2 rounded w-full mb-2" oninput="generateKodeBarang()">
            <input type="text" id="brand" placeholder="Brand" class="border p-2 rounded w-full mb-2" oninput="generateKodeBarang()">
            
            <select id="kodeUnit" class="border p-2 rounded w-full mb-2" onchange="generateKodeBarang()">
                <option value="">Pilih Kode Unit</option>
                <option value="IT">IT</option>
                <option value="ELEKTRONIK">ELEKTRONIK</option>
                <option value="FURNITURE">FURNITURE</option>
            </select>
            
            <select id="statusPajak" class="border p-2 rounded w-full mb-2">
                <option value="Bukan Barang Pajak">Bukan Barang Pajak</option>
                <option value="Lunas">Lunas</option>
                <option value="Belum Dibayar">Belum Dibayar</option>
            </select>
            
            <select id="statusRiwayat" class="border p-2 rounded w-full mb-2">
                <option value="Tersedia-Digunakan">Tersedia-Digunakan</option>
                <option value="Tersedia-Tidak Digunakan">Tersedia-Tidak Digunakan</option>
                <option value="Tidak Tersedia-Dalam Perawatan">Tidak Tersedia-Dalam Perawatan</option>
                <option value="Scraping">Scraping</option>
            </select>
            
            <select id="perawatan" class="border p-2 rounded w-full mb-2">
                <option value="">Pilih Status Perawatan</option>
                <option value="Service">Service</option>
                <option value="Baik">Baik</option>
                <option value="Perlu Perbaikan">Perlu Perbaikan</option>
            </select>
            
            <input type="text" id="lokasi" placeholder="Lokasi" class="border p-2 rounded w-full mb-2">
            <input type="number" id="tahunPengadaan" placeholder="Tahun Pengadaan" class="border p-2 rounded w-full mb-2" oninput="generateKodeBarang()">
            
            <div class="flex gap-2">
                <button onclick="simpanData()" id="btnSimpan" class="bg-blue-500 text-white p-2 rounded flex-1">Tambah</button>
                <button onclick="batalEdit()" id="btnBatal" class="bg-gray-500 text-white p-2 rounded hidden">Batal</button>
            </div>
        </div>

        <div class="md:w-2/3 bg-gray-50 p-4 rounded-lg shadow overflow-auto">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-1">
                    <input type="text" id="inputPencarian" placeholder="Cari berdasarkan nama atau kode..." class="border p-2 rounded w-full">
                </div>
                <div class="flex gap-2">
                    <select id="sortirBy" class="border p-2 rounded">
                        <option value="">Urutkan</option>
                        <option value="nama-asc">Nama (A-Z)</option>
                        <option value="nama-desc">Nama (Z-A)</option>
                        <option value="tahun-asc">Tahun (Terlama)</option>
                        <option value="tahun-desc">Tahun (Terbaru)</option>
                        <option value="kategori-asc">Kategori (A-Z)</option>
                    </select>
                    <button onclick="cariData()" class="bg-blue-500 text-white p-2 rounded">Cari</button>
                </div>
            </div>

            <table class="w-full border-collapse border border-gray-300 text-sm">
                <thead class="bg-gray-200 text-gray-700">
                    <tr>
                        <th class="border p-2">No</th>
                        <th class="border p-2">Kode Barang</th>
                        <th class="border p-2">Nama Barang</th>
                        <th class="border p-2">Brand</th>
                        <th class="border p-2">Kode Unit</th>
                        <th class="border p-2">Status Pajak</th>
                        <th class="border p-2">Status Riwayat</th>
                        <th class="border p-2">Perawatan</th>
                        <th class="border p-2">Lokasi</th>
                        <th class="border p-2">Tahun</th>
                        <th class="border p-2">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <button onclick="cetakPDF()" class="bg-green-500 text-white p-2 rounded mt-4">Cetak PDF</button>
        </div>
    </div>

    <script>
        let dataAlat = JSON.parse(localStorage.getItem("dataAlat")) || [];
        let nomorUrut = dataAlat.length ? parseInt(dataAlat[dataAlat.length - 1].nomor) + 1 : 1;
        let dataTampil = [...dataAlat];

        function generateKodeBarang() {
            const namaBarang = document.getElementById("namaBarang").value.trim();
            const brand = document.getElementById("brand").value.trim();
            const kodeUnit = document.getElementById("kodeUnit").value;
            const tahunPengadaan = document.getElementById("tahunPengadaan").value.trim();
            
            if (namaBarang && brand && kodeUnit && tahunPengadaan) {
                const kodePemilik = "PLA";
                const kodeNama = namaBarang.substring(0, 3).replace(/\s+/g, "").toUpperCase();
                const kodeBrand = brand.substring(0, 3).replace(/\s+/g, "").toUpperCase();
                const nomorUnit = String(nomorUrut).padStart(3, '0');
                
                const kodeBarang = `${kodePemilik}-${kodeUnit}-${kodeNama}${kodeBrand}-${nomorUnit}-${tahunPengadaan}`;
                document.getElementById("kodeBarangDisplay").textContent = kodeBarang;
                return kodeBarang;
            } else {
                document.getElementById("kodeBarangDisplay").textContent = "Isi semua field untuk generate kode";
                return null;
            }
        }

        function simpanData() {
            const kodeBarang = generateKodeBarang();
            const namaBarang = document.getElementById("namaBarang").value.trim();
            const brand = document.getElementById("brand").value.trim();
            const kodeUnit = document.getElementById("kodeUnit").value;
            const statusPajak = document.getElementById("statusPajak").value;
            const statusRiwayat = document.getElementById("statusRiwayat").value;
            const perawatan = document.getElementById("perawatan").value;
            const lokasi = document.getElementById("lokasi").value.trim();
            const tahunPengadaan = document.getElementById("tahunPengadaan").value.trim();
            const editIndex = document.getElementById("editIndex").value;
            
            if (!kodeBarang || !namaBarang || !brand || !kodeUnit || !tahunPengadaan) {
                alert("Field wajib harus diisi!");
                return;
            }

            if (editIndex === "") {
                dataAlat.push({ 
                    nomor: nomorUrut, 
                    kodeBarang,
                    namaBarang, 
                    brand,
                    kodeUnit, 
                    statusPajak,
                    statusRiwayat,
                    perawatan,
                    lokasi,
                    tahunPengadaan
                });
                nomorUrut++;
                localStorage.setItem("dataAlat", JSON.stringify(dataAlat));
                alert("Data berhasil ditambahkan!");
            } else {
                const index = parseInt(editIndex);
                dataAlat[index] = {
                    ...dataAlat[index],
                    kodeBarang,
                    namaBarang, 
                    brand,
                    kodeUnit, 
                    statusPajak,
                    statusRiwayat,
                    perawatan,
                    lokasi,
                    tahunPengadaan
                };
                localStorage.setItem("dataAlat", JSON.stringify(dataAlat));
                alert("Data berhasil diperbarui!");
                batalEdit();
            }
            
            dataTampil = [...dataAlat];
            tampilkanData();
            resetForm();
        }

        function editData(index) {
            const item = dataAlat[index];
            document.getElementById("editIndex").value = index;
            document.getElementById("namaBarang").value = item.namaBarang;
            document.getElementById("brand").value = item.brand;
            document.getElementById("kodeUnit").value = item.kodeUnit;
            document.getElementById("statusPajak").value = item.statusPajak;
            document.getElementById("statusRiwayat").value = item.statusRiwayat;
            document.getElementById("perawatan").value = item.perawatan;
            document.getElementById("lokasi").value = item.lokasi;
            document.getElementById("tahunPengadaan").value = item.tahunPengadaan;
            
            // Update kode barang display
            document.getElementById("kodeBarangDisplay").textContent = item.kodeBarang;
            
            document.getElementById("btnSimpan").textContent = "Update";
            document.getElementById("btnBatal").classList.remove("hidden");
        }

        function batalEdit() {
            resetForm();
            document.getElementById("editIndex").value = "";
            document.getElementById("btnSimpan").textContent = "Tambah";
            document.getElementById("btnBatal").classList.add("hidden");
        }

        function resetForm() {
            document.getElementById("namaBarang").value = "";
            document.getElementById("brand").value = "";
            document.getElementById("kodeUnit").value = "";
            document.getElementById("statusPajak").value = "Bukan Barang Pajak";
            document.getElementById("statusRiwayat").value = "Tersedia-Digunakan";
            document.getElementById("perawatan").value = "";
            document.getElementById("lokasi").value = "";
            document.getElementById("tahunPengadaan").value = "";
            document.getElementById("kodeBarangDisplay").textContent = "Isi semua field untuk generate kode";
        }

        function hapusData(index) {
            if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
                dataAlat.splice(index, 1);
                localStorage.setItem("dataAlat", JSON.stringify(dataAlat));
                alert("Data berhasil dihapus!");
                dataTampil = [...dataAlat];
                tampilkanData();
            }
        }

        function cariData() {
            const keyword = document.getElementById("inputPencarian").value.toLowerCase();
            const sortBy = document.getElementById("sortirBy").value;
            
            if (keyword) {
                dataTampil = dataAlat.filter(item => 
                    item.namaBarang.toLowerCase().includes(keyword) || 
                    item.kodeBarang.toLowerCase().includes(keyword)
                );
            } else {
                dataTampil = [...dataAlat];
            }
            
            if (sortBy) {
                const [field, direction] = sortBy.split("-");
                dataTampil.sort((a, b) => {
                    let valA, valB;
                    
                    if (field === "tahun") {
                        valA = parseInt(a.tahunPengadaan);
                        valB = parseInt(b.tahunPengadaan);
                    } else if (field === "nama") {
                        valA = a.namaBarang.toLowerCase();
                        valB = b.namaBarang.toLowerCase();
                    } else if (field === "kategori") {
                        valA = a.kodeUnit.toLowerCase();
                        valB = b.kodeUnit.toLowerCase();
                    }
                    
                    if (direction === "asc") {
                        return valA > valB ? 1 : -1;
                    } else {
                        return valA < valB ? 1 : -1;
                    }
                });
            }
            
            tampilkanData();
        }

        function tampilkanData() {
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = dataTampil.map((item, index) => `
                <tr class="text-center">
                    <td class="border p-2">${item.nomor}</td>
                    <td class="border p-2 font-mono">${item.kodeBarang}</td>
                    <td class="border p-2">${item.namaBarang}</td>
                    <td class="border p-2">${item.brand}</td>
                    <td class="border p-2">${item.kodeUnit}</td>
                    <td class="border p-2">${item.statusPajak}</td>
                    <td class="border p-2">${item.statusRiwayat}</td>
                    <td class="border p-2">${item.perawatan || '-'}</td>
                    <td class="border p-2">${item.lokasi || '-'}</td>
                    <td class="border p-2">${item.tahunPengadaan}</td>
                    <td class="border p-2">
                        <button onclick="editData(${dataAlat.findIndex(d => d.nomor === item.nomor)})" class="bg-yellow-500 text-white p-1 rounded mr-1">Edit</button>
                        <button onclick="hapusData(${dataAlat.findIndex(d => d.nomor === item.nomor)})" class="bg-red-500 text-white p-1 rounded">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        function cetakPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
        
            doc.setFontSize(16);
            doc.setTextColor(40);
            doc.setFont("helvetica", "bold");
            doc.text("LAPORAN DATA ALAT", 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.setFont("helvetica", "normal");
            doc.text(`Dicetak pada: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
            
            const headers = [
                "No", 
                "Kode Barang", 
                "Nama Barang", 
                "Brand", 
                "Kode Unit", 
                "Status Pajak",
                "Status Riwayat",
                "Perawatan",
                "Lokasi",
                "Tahun"
            ];
            
            const data = dataTampil.map(item => [
                item.nomor,
                item.kodeBarang,
                item.namaBarang,
                item.brand,
                item.kodeUnit,
                item.statusPajak,
                item.statusRiwayat,
                item.perawatan || '-',
                item.lokasi || '-',
                item.tahunPengadaan
            ]);
            
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 30,
                theme: 'grid',
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                margin: { top: 30 }
            });
        
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text(`Halaman ${i} dari ${pageCount}`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
            }
            
            doc.save("Laporan_Data_Alat.pdf");
        }

        document.getElementById("inputPencarian").addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                cariData();
            }
        });

        tampilkanData();
    </script>
</body>
</html>
